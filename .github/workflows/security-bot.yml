# Source: Inspired by https://github.com/anthropics/claude-code-security-review
name: Claude Security Review Bot

# Fire fairly indiscrimately, but exit if the body doesn't contain the @claude keyword.
on:
    pull_request:

jobs:
    check-membership:
        if: |
            github.actor != 'claude[bot]'
        runs-on: ubuntu-latest
        outputs:
            is-member: ${{ steps.check.outputs.allowed }}
        steps:
            - name: Check if actor is an org member
              id: check
              uses: actions/github-script@v7
              with:
                  script: |
                      const org = 'seqeralabs';
                      const user = context.actor;

                      try {
                        await github.rest.orgs.checkMembershipForUser({
                          org,
                          username: user
                        });
                        core.setOutput('allowed', 'true');
                        console.log(`✓ User ${user} is a member of ${org}`);
                      } catch (err) {
                        core.setOutput('allowed', 'false');
                        console.log(`✗ User ${user} is not a member of ${org}`);
                      }

    claude-code-security-action:
        needs: check-membership
        if: needs.check-membership.outputs.is-member == 'true'
        runs-on: ubuntu-latest
        # TODO: Add more details on where this came from
        permissions:
            pull-requests: write # Needed for leaving PR comments
            contents: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4 # TODO: why not v6?
              with:
                  ref: ${{ github.event.pull_request.head.sha || github.sha }}
                  fetch-depth: 2

            - name: Run Claude Code Security Action
              uses: anthropics/claude-code-security-review@main
              timeout-minutes: 60
              with:
                  comment-pr: true
                  anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
                  timeout_minutes: "60" # TODO: Why is timeout here again?
                  # TODO: Build this out later
                  settings: |
                      {
                      "hooks": {}
                      }
                  # mode: tag  # Default: responds to @claude mentions
                  # Optional: Restrict network access to specific domains only
                  # experimental_allowed_domains: |
                  #   .anthropic.com
                  #   .github.com
                  #   api.github.com
                  #   .githubusercontent.com
                  #   bun.sh
                  #   registry.npmjs.org
                  #   .blob.core.windows.net
