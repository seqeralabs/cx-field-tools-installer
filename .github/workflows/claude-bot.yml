# Source: Inspired by Platform repo's '.github/workflows/claude.yml'
name: Claude PR Assistant

# Fire fairly indiscrimately, but exit if the body doesn't contain the @claude keyword.
on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    check-membership:
        if: |
            (github.actor != 'claude[bot]') &&
              ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
              (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
              (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
              (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
            )
        runs-on: ubuntu-latest
        outputs:
            is-member: ${{ steps.check.outputs.allowed }}
        steps:
            - name: Check if actor is an org member
              id: check
              uses: actions/github-script@v7
              with:
                  script: |
                      const org = 'seqeralabs';
                      const user = context.actor;

                      try {
                        await github.rest.orgs.checkMembershipForUser({
                          org,
                          username: user
                        });
                        core.setOutput('allowed', 'true');
                        console.log(`✓ User ${user} is a member of ${org}`);
                      } catch (err) {
                        core.setOutput('allowed', 'false');
                        console.log(`✗ User ${user} is not a member of ${org}`);
                      }

    claude-code-action:
        needs: check-membership
        if: needs.check-membership.outputs.is-member == 'true'
        runs-on: ubuntu-latest
        # TODO: Add more details on where this came from
        permissions:
            contents: read
            pull-requests: read
            issues: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4 # TODO: why not v6?
              with:
                  fetch-depth: 1

            - name: Run Claude Code Action
              uses: anthropics/claude-code-action@v1
              timeout-minutes: 60
              with:
                  anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
                  timeout_minutes: "60" # TODO: Why is timeout here again?
                  # TODO: Build this out later
                  settings: |
                      {
                      "hooks": {}
                      }
                  # mode: tag  # Default: responds to @claude mentions
                  # Optional: Restrict network access to specific domains only
                  # experimental_allowed_domains: |
                  #   .anthropic.com
                  #   .github.com
                  #   api.github.com
                  #   .githubusercontent.com
                  #   bun.sh
                  #   registry.npmjs.org
                  #   .blob.core.windows.net
